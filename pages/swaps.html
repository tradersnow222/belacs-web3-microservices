<!DOCTYPE html>
<html>
    <head>
        <title>Swaps</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
        <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"
        type="application/javascript"></script>

        <script>

        </script>

    </head>

    <body>  
        <!-- headder bar to redirect to home -->
        <nav class="navbar-inverse">
            <div>
                <div class="container-fluid">
                    <div class="navbar-header">
                        <a class="navbar-brand" href="/">Home</a>
                    </div>
                </div>
            </div>
            <div class="network-select">
                <div class="dropdown">
                    <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Ethereum
                    <span class="caret"></span></button>
                    <ul class="dropdown-menu">
                        <li><a href="#" onclick="chainID=1">Ethereum</a></li>
                        <li><a href="#" onclick="chainID=10">Optimism</a></li>
                        <li><a href="#" onclick="chainID=56">BNB Chain</a></li>
                        <li><a href="#" onclick="chainID=100">Gnosis</a></li>
                        <li><a href="#" onclick="chainID=137">Polygon</a></li>
                        <li><a href="#" onclick="chainID=250">Fantom</a></li>
                        <li><a href="#" onclick="chainID=42161">Arbitrum</a></li>
                        <li><a href="#" onclick="chainID=43114">Avalanche</a></li>
                        <!-- klaytn and aurora aren't supported by tenderly so we'll leave them in comments -->
                        <!-- <li><a href="#" onclick="chainID=8217">Klaytn</a></li> -->
                        <!-- <li><a href="#" onclick="chainID=1313161554">Aurora</a></li> -->                    
                    </ul>
                </div>
            </div>
        </nav>
        <!-- this will be a centered form to hold the swap widget -->
        <div class="container-widget">
            <div class="widget">
                <!-- widget header with a left aligned SWAP text and 3 right aligned buttons, refresh, + and settings  all on the same row-->
                <div class="widget-header">
                    <div class="col-sm-3">
                        <h3>SWAP</h3>
                    </div>
                    <div class="col-sm-9">
                        <button type="button" class="btn btn-default btn-sm" id="widget-refresh">
                            <span class="glyphicon glyphicon-refresh"></span> <!-- Refresh-->
                        </button>
                        <button type="button" class="btn btn-default btn-sm" id="widget-add">
                            <span class="glyphicon glyphicon-plus"></span> <!-- Add -->
                        </button>
                        <button type="button" class="btn btn-default btn-sm" id="widget-settings">
                            <span class="glyphicon glyphicon-cog"></span> <!-- Settings -->
                        </button>
                    </div>
                </div>
                <!-- the "you sell" field of the widget. A master div has 3 left aligned elements and 3 right aligned elements -->
                <div class="widget-sell">
                    <!-- first row, the left align is the "you sell" hyperlink the rigth align is "Balance" -->
                    <div class="row">
                        <div class="col-sm-3">
                            <a target="_blank" id="you-sell" href="#">You Sell</a>
                        </div>
                        <div class="col-sm-9">
                            <a href="#">Balance</a>
                        </div>
                    </div>
                    <!-- The second row, the left is a drop down for token selection (filled by javascript) and the rigth is an editable div for input amounts -->
                    <div class="row">
                        <div class="col-sm-3">
                            <div class="dropdown">
                                <button id="token-button-sell" class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Select Token
                                <span class="caret"></span></button>
                                <ul class="dropdown-menu" id="token-list-selector-sell">
                                    <!-- javascript will fill this -->
                                </ul>
                            </div>
                        </div>
                        <!-- this input will just be a transparent editable div that's right aligned -->
                        <div class="col-sm-9">
                            <div class="input-group">
                                <div contenteditable="true" class="sell-amount" id="sell-amount">0.0</div>
                            </div>
                        </div>
                    </div>
                    <!-- the third row will be token full name and price, but we won't have this for now-->
                </div>

                <!-- button with arrows side by side pointing up and down to allow the user to flip the buy and sell token -->
                <div class="widget-button">
                    <button type="button" class="btn btn-default btn-sm" id="widget-flip">
                        <span class="glyphicon glyphicon-arrow-up"></span>
                        <span class="glyphicon glyphicon-arrow-down"></span>
                    </button>
                </div>

                <!-- same thing as widget sell but instead it's you buy -->
                <div class="widget-buy">
                    <div class="row">
                        <div class="col-sm-3">
                            <a target="_blank" id="you-buy" href="#">You Buy</a>
                        </div>
                        <div class="col-sm-9">
                            <a href="#">Balance</a>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-3">
                            <div class="dropdown">
                                <button id="token-button-buy" class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Select Token
                                <span class="caret"></span></button>
                                <ul class="dropdown-menu" id="token-list-selector-buy">
                                    <!-- javascript will fill this -->
                                </ul>
                            </div>
                        </div>
                        <div class="col-sm-9">
                            <div class="input-group">
                                <div class="" id="buyAmount">0</div> <!-- no contentEditable because we can't quote in reverse -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- lastly we'll have a "connect wallet" button that will bring up a popup asking for a wallet. Once there's a valid wallet, it will change to the "swap" button -->
                <div class="widget-connect">
                    <button type="button" class="btn btn-primary" id="connectButton">Connect Public Address</button>
                </div>
                <!-- disconnect wallet button, not visible by default -->
                <div class="widget-disconnect">
                    <button type="button" class="btn btn-primary" id="disconnectButton">Disconnect Wallet</button>
                </div>
                <!-- finally, a place to display the connected address in small 6pt font -->
                <div class="widget-address">
                    <p id="address"></p>
                </div>  
                <!-- errors -->
                <div class="widget-error" id="widget-error">
                </div>
            </div>
        </div>
    </body>

    <style>
        .navbar-inverse {
            display: flex;
            flex-direction: row;
        }
        /* add padding to the network-select to fit within */
        .network-select {
            padding: 7px;
        }
        .container-widget{
            display: flex;
            justify-content: center;
        }
        .widget{
            width:100%;
            max-width: 500px;
            border: 1px solid black;
            border-radius: 5px;
            padding: 10px;
            margin: 20px;
            height:400px; /* maybe can be tinier? */
        }
        .widget-header{
            display: flex;
            flex-direction: row;
            /* make sure everything is lined up */
            align-items: center;
        }
        /* right align the settings */
        .widget-header > div:nth-child(2){
            display: flex;
            justify-content: flex-end;
            /* space the inside elements */
            gap: 10px;
        }
        .widget-sell{
            /* give it a grey background */
            background-color: #e6e6e6;
            /* give it a border */
            border: 1px solid black;
            border-radius: 5px;
            padding: 10px;
            margin: 10px;
            height: fit-content;
        }
        /* the first row in widget-sell, left align the first element and right align the second */
        .widget-sell > div:nth-child(1){
            display: flex;
            flex-direction: row;
            align-items: center;
        }
        .widget-sell > div:nth-child(1) > div:nth-child(2){
            display: flex;
            justify-content: flex-end;
        }
        /* the second row in widget-sell, left align the first element and right align the second */
        .widget-sell > div:nth-child(2){
            display: flex;
            flex-direction: row;
            align-items: center;
        }
        .widget-sell > div:nth-child(2) > div:nth-child(2){
            display: flex;
            justify-content: flex-end;
        }
        .input-group{
            width: 100%;
            text-align: right;
        }
        .widget-buy{
            /* give it a grey background */
            background-color: #e6e6e6;
            /* give it a border */
            border: 1px solid black;
            border-radius: 5px;
            padding: 10px;
            margin: 10px;
            height: fit-content;
        }
        /* the first row in widget-buy, left align the first element and right align the second */
        .widget-buy > div:nth-child(1){
            display: flex;
            flex-direction: row;
            align-items: center;
        }
        .widget-buy > div:nth-child(1) > div:nth-child(2){
            display: flex;
            justify-content: flex-end;
        }
        /* the second row in widget-buy, left align the first element and right align the second */
        .widget-buy > div:nth-child(2){
            display: flex;
            flex-direction: row;
            align-items: center;
        }
        .widget-buy > div:nth-child(2) > div:nth-child(2){
            display: flex;
            justify-content: flex-end;
        }

        /* center widget-button */
        .widget-button{
            display: flex;
            justify-content: center;
            align-items: center;
        }
        /* center widget-connect */
        .widget-connect{
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .widget-connect > button{
            width: 97%;
        }

        .widget-disconnect {
            /* hide the button */
            visibility: hidden;
            /* add a little padding so it doesn't run up against the connect button */
            padding: 5px;
            /* right align the content */
            display: flex;
            justify-content: flex-end;
        }

        .widget-address{
            /* add a little padding so it doesn't run up against the connect button */
            padding: 5px;
            /* center */
            display: flex;
            justify-content: center;
            align-items: center;
            /* shrink the font and color it grey */
            font-size: 6pt;
            color: grey;
        }

        .widget-error{
            /* add a little padding so it doesn't run up against the connect button */
            padding: 5px;
            /* center */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12pt;
        }

    </style>
    <script>
        // store all the RPC endpoints here
        const ETH_RPC = "https://cloudflare-eth.com";
        const BSC_RPC = "https://bsc-dataseed.binance.org";
        const MATIC_RPC = "https://rpc-mainnet.maticvigil.com";
        const AVALANCHE_RPC = "https://api.avax.network/ext/bc/C/rpc";
        const FANTOM_RPC = "https://rpcapi.fantom.network";
        // const HECO_RPC = "https://http-mainnet.hecochain.com";
        // const MOONBEAM_RPC = "https://rpc.testnet.moonbeam.network";
        const XDAI_RPC = "https://rpc.xdaichain.com";
        const ARBITRUM_RPC = "https://arb1.arbitrum.io/rpc";
        // const CELO_RPC = "https://forno.celo.org";
        const OPTIMISM_RPC = "https://mainnet.optimism.io";
        // const OKEX_RPC = "https://exchainrpc.okex.org";
        // const KCC_RPC = "https://rpc-mainnet.kcc.network";
        // const HARMONY_RPC = "https://api.s0.b.hmny.io";
        const AURORA_RPC = "https://mainnet.aurora.dev";
        const KLAYTN_RPC = "https://node-api.klaytnapi.com/v1/klaytn";
        
        // error codes
        const IMPORT_ERROR = 4001;
        const ACCOUNT_ERROR = 4002;
        const CHAIN_ERROR = 4003;
        const RPC_ERROR = 4004;
        const TOKEN_ERROR = 4005;
        const SIMULATION_ERROR = 4006;
        const AMOUNT_ERROR = 4007;
        const RENDER_ERROR = 4008;
        const REMOTE_ERROR = 4009;

        function searchTokenListSell()
        {
            // Declare variables
            var input, filter, ul, li, a, i, txtValue;
            input = document.getElementById('token-search-sell');
            filter = input.value.toUpperCase();
            ul = document.getElementById("token-list-selector-sell");
            li = ul.getElementsByTagName('button');

            // Loop through all list items, and hide those who don't match the search query
            for (i = 0; i < li.length; i++) {
                 // Loop through all list items, and hide those who don't match the search query
                 if (filter.length == 42) {
                    // if it's an address, check if the li[i].value matches
                    txtValue = li[i].value.toUpperCase();
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        li[i].style.display = "";
                        li[i].style.visibility = "visible";
                    } else {
                        li[i].style.display = "none";
                        li[i].style.visibility = "hidden";
                    }
                } else {
                    // if it's not an address, check if the li[i].text matches
                    txtValue = li[i].innerText.toUpperCase();
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        li[i].style.display = "";
                        li[i].style.visibility = "visible";
                    } else {
                        li[i].style.display = "none";
                        li[i].style.visibility = "hidden";
                    }
                 }
            }
        }

        function searchTokenListBuy()
        {
            // Declare variables
            var input, filter, ul, li, a, i, txtValue;
            input = document.getElementById('token-search-buy');
            filter = input.value.toUpperCase();
            ul = document.getElementById("token-list-selector-buy");
            li = ul.getElementsByTagName('button');
            // Loop through all list items, and hide those who don't match the search query
            for (i = 0; i < li.length; i++) {
                // check if the search term is the token symbol or an address
                if(filter.length == 42){
                    // if it's an address, check if the address matches
                    txtValue = li[i].value.toUpperCase();

                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        li[i].style.display = "";
                        li[i].style.visibility = "visible";
                    } else {
                        li[i].style.display = "none";
                        li[i].style.visibility = "hidden";
                    }
                } else {
                    // if it's not an address, check if the symbol matches
                    txtValue = li[i].innerText.toUpperCase();
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        li[i].style.display = "";
                        li[i].style.visibility = "visible";
                    } else {
                        li[i].style.display = "none";
                        li[i].style.visibility = "hidden";
                    }
                }
            }
        }

        function populateTokenDropdown(tokenlist)
        {

            // expected tokenlist will look like
            // {"0x0327112423f3a68efdf1fcf402f6c5cb9f7c33fd":{"symbol":"BTC++","name":"PieDAO BTC++","decimals":18,"address":"0x0327112423f3a68efdf1fcf402f6c5cb9f7c33fd","logoURI":"https://tokens.1inch.io/0x0327112423f3a68efdf1fcf402f6c5cb9f7c33fd.png","tags":["tokens","PEG:BTC"]},"0x04fa0d235c4abf4bcf4787af4cf447de572ef828":{"symbol":"UMA","name":"UMA Voting Token v1","decimals":18,"address":"0x04fa0d235c4abf4bcf4787af4cf447de572ef828","logoURI":"https://tokens.1inch.io/0x04fa0d235c4abf4bcf4787af4cf447de572ef828.png","tags":["tokens"]}}
            // we want to populate the dropdown with the symbol and address along with a search bar at the top of the token list
            let dropdownBuy = document.getElementById("token-list-selector-buy");
            let dropdownSell = document.getElementById("token-list-selector-sell");
            // clear the dropdown
            dropdownBuy.innerHTML = "";
            dropdownSell.innerHTML = "";
            // add a search bar
            let searchbar_sell = document.createElement("input");
            searchbar_sell.setAttribute("type", "text");
            searchbar_sell.setAttribute("id", "token-search-sell");
            searchbar_sell.setAttribute("onkeyup", "searchTokenListSell()");
            searchbar_sell.setAttribute("placeholder", "Search for tokens...");
            dropdownSell.appendChild(searchbar_sell);
            let searchbar_buy = document.createElement("input");
            searchbar_buy.setAttribute("type", "text");
            searchbar_buy.setAttribute("id", "token-search-buy");
            searchbar_buy.setAttribute("onkeyup", "searchTokenListBuy()");
            searchbar_buy.setAttribute("placeholder", "Search for tokens...");
            dropdownBuy.appendChild(searchbar_buy);



            // add the tokens for the sell dropdown
            let sellOptionString = "";
            for (const [key, value] of Object.entries(tokenlist)) {
                // create a new option element
                let option = document.createElement("button");
                // set the value to the address
                option.setAttribute("value", key);
                // set the text to the symbol
                option.innerText = value.symbol;
                // when the option is clicked, set the text of the button to the symbol, also edit the "you sell" hyperlink to https://blockscan.com/address/ + address
                option.setAttribute("onclick", "document.getElementById('token-button-sell').innerHTML = this.innerText; document.getElementById('token-button-sell').value = this.value; document.getElementById('you-sell').href = 'https://blockscan.com/address/' + this.value;");
                // set the style width to 100%
                option.setAttribute("style", "width: 100%;");
                // add the option to the dropdown
                sellOptionString += option.outerHTML;
            }
            dropdownSell.innerHTML += sellOptionString;

            let stringOfOptionsBuy = "";
            // add the tokens for the buy dropdown
            for (const [key, value] of Object.entries(tokenlist)) {
                // create a new option element
                let option = document.createElement("button");
                // set the value to the address
                option.setAttribute("value", key);
                // set the text to the symbol
                option.innerText = value.symbol;
                // when the option is clicked, set the text of the button to the symbol
                option.setAttribute("onclick", "document.getElementById('token-button-buy').innerHTML = this.innerText; document.getElementById('token-button-buy').value = this.value; document.getElementById('you-buy').href = 'https://blockscan.com/address/' + this.value;");
                // set the style width to 100%
                option.setAttribute("style", "width: 100%;");
                // add the option to the dropdown
                stringOfOptionsBuy += option.outerHTML;
            }
            dropdownBuy.innerHTML += stringOfOptionsBuy;

        }

        function getTokenList()
        {
            let url = `https://tokens.1inch.io/v1.1/${chainID}`;
            let tokenList = localStorage.getItem(`tokenList-${chainID}`);
            if(tokenList){
                // we have the token list in local storage, parse it and populate the dropdown
                tokenList = JSON.parse(tokenList);
                let customTokenList = localStorage.getItem(`customTokens-${chainID}`);
                if(customTokenList){
                    customTokenList = JSON.parse(customTokenList);
                    for (const [key, value] of Object.entries(customTokenList)) {
                        tokenList[key] = value;
                    }
                }
                // populateTokenDropdown(tokenList);
            } else {
                // we don't have the token list in local storage, fetch it from the API
                fetch(url)
                .then(response => response.json())
                .then(data => {
                    // store the token list in local storage
                    localStorage.setItem(`tokenList-${chainID}`, JSON.stringify(data));
                    tokenList = data;
                    // populate the dropdown
                    populateTokenDropdown(data);
                })
                .catch((error) => {
                    errorHandler(REMOTE_ERROR);
                });
            }
            return tokenList;
        }

        // listen for the chain dropdown button to be clicked and change the text to the selected network
        $('.dropdown-menu li a').click(function(){
            var selText = $(this).text();
            $(this).parents('.dropdown').find('.dropdown-toggle').html(selText+' <span class="caret"></span>');
            // if we wanted to we could change the style of the button to match the network selected
            // TODO: change the style of the button to match the network selected

            populateTokenDropdown(getTokenList());

            // once populated, if the chainID is 1 then we'll default to ETH/1inch
            // but first, clear the token buttons
            let buyButton = document.getElementById("token-button-buy");
            let sellButton = document.getElementById("token-button-sell");
            let youBuy = document.getElementById("you-buy");
            let youSell = document.getElementById("you-sell");
            sellButton.innerText = "Select a token";
            buyButton.value = "";
            buyButton.innerText = "Select a token";
            sellButton.value = "";
            switch(chainID)
            {
                case 1:
                    sellButton.innerText = "ETH";
                    sellButton.value = "0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee";
                    buyButton.innerText = "1inch";
                    buyButton.value = "0x111111111117dc0aa78b770fa6a738034120c302";
                    youBuy.href = "https://etherscan.io/address/0x111111111117dc0aa78b770fa6a738034120c302";
                    youSell.href = "https://etherscan.io/address/0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee";
                    break;
                case 10: 
                    sellButton.innerText = "ETH";
                    sellButton.value = "0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee";
                    // TODO: change to the first token in the tokenList-10

                    youSell = "https://optimistic.etherscan.io/address/0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee";
                    break;
                case 56:
                    sellButton.innerText = "BNB";
                    sellButton.value = "0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee";
                    buyButton.innerText = "1inch";
                    buyButton.value = "0x111111111117dc0aa78b770fa6a738034120c302";
                    youBuy.href = "https://bscscan.com/address/0x111111111117dc0aa78b770fa6a738034120c302";
                    youSell.href = "https://bscscan.com/address/0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee";
                    break;
                case 137:
                    sellButton.innerText = "MATIC";
                    sellButton.value = "0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee";
                    // TODO: change to the first token in the tokenList-137

                    youSell = "https://polygonscan.com/address/0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee";
                    break;
                case 250:
                    sellButton.innerText = "FTM";
                    sellButton.value = "0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee";
                    // TODO: change to the first token in the tokenList-250

                    youSell = "https://ftmscan.com/address/0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee";
                    break;
                case 42161:
                    sellButton.innerText = "ETH";
                    sellButton.value = "0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee";
                    // TODO: change to the first token in the tokenList-42161

                    youSell = "https://arbiscan.io/address/0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee";
                    break;
                case 43114:
                    sellButton.innerText = "ETH";
                    sellButton.value = "0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee";
                    // TODO: change to the first token in the tokenList-43114

                    youSell = "https://blockscan.com/address/0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee";
                    break;
            }
        });

        // this is the javascript code to handle the "widget-connect" button and replace it with a "swap" button once a wallet is connected
        $('.widget-connect').click(function(){
            // if the #address element is empty, ask for a connection
            if($('#address').text() == "")
            {
                // alert askign for a wallet address
                var walletAddress = prompt("Please enter your wallet address", "0x");
                // if the wallet address is valid, replace the "connect wallet" button with a "swap" button
                if (walletAddress != null) {
                    // remove leading and trailing whitespace
                    walletAddress = walletAddress.trim();
                    // check if the wallet address is valid
                    if (walletAddress.startsWith("0x") && walletAddress.length == 42) {
                        // replace the "connect wallet" button with a "swap" button
                        $('.widget-connect').html('<button type="button" class="btn btn-primary" id="swap-button">Swap</button>');
                        // show the "disconnect wallet" button
                        $('.widget-disconnect').css('visibility', 'visible');
                        // display the wallet address
                        $('#address').html(walletAddress);
                    } else if(walletAddress.indexOf('.eth') != -1){
                        // use ethers to resolve the ENS name
                        let provider = new ethers.providers.JsonRpcProvider(ETH_RPC); // can only resolve ENS on mainnet
                        provider.resolveName(walletAddress).then((address) => {
                            // replace the "connect wallet" button with a "swap" button
                            $('.widget-connect').html('<button type="button" class="btn btn-primary" id="swap-button">Swap</button>');
                            // show the "disconnect wallet" button
                            $('.widget-disconnect').css('visibility', 'visible');
                            // display the wallet address
                            $('#address').html(address);
                        });
                    }
                }
            } 
            else {
                // if the address isn't empty, the user wants to swap. 
                // first, get the token addresses from the "value" property of the buttons
                let sellToken = document.getElementById("token-button-sell").value;
                let buyToken = document.getElementById("token-button-buy").value;
                // get the amount to sell from the input box
                let sellAmount = document.getElementById("sell-amount").innerText;
                // get the address of the wallet
                let walletAddress = document.getElementById("address").innerText;
                let baseURL = `https://api.1inch.io/v5.0/${chainID}/swap`
                // get the token lists so we can get the decimals of the tokens
                let tokenList = JSON.parse(localStorage.getItem(`tokenList-${chainID}`));
                let customTokenList = JSON.parse(localStorage.getItem(`customTokenList-${chainID}`));
                let decimals = tokenList[sellToken].decimals || customTokenList[sellToken].decimals;
                // convert the amount to sell to wei using bigNumber
                let sellAmountWei = ethers.utils.parseUnits(sellAmount, decimals);
                // let sellAmountWei = ethers.utils.parseUnits(sellAmount, decimals);
                let slippage;
                try{
                   slippage = localStorage.getItem("slippage");
                }
                catch{
                    slippage = 49;
                }

                // build the URL for the 1inch API
                //let url = baseURL + `?fromTokenAddress=${sellToken}&toTokenAddress=${buyToken}&amount=${sellAmountWei}&fromAddress=${walletAddress}&slippage=1&disableEstimate=true`;


                // post the url to /simulate
                // if the amount isn't 0, simulate the swap
                if(parseInt(sellAmount) != 0)
                {
                    $.post('/simulate', 
                    {
                        fromTokenAddress: sellToken,
                        toTokenAddress: buyToken,
                        amount: sellAmountWei.toString(),
                        fromAddress: walletAddress,
                        slippage: slippage,
                        chainID: chainID
                    }, function(data){
                        console.log(data);
                        // if data.status == 200, share the link with the user
                        if(data.status == 200){
                            let id = data.details.simulationID;
                            let simulationURL = `https://dashboard.tenderly.co/public/Natalia/1inch-governance/simulator/${id}`;
                            
                            if(data.details.success == false)
                            {
                                errorHandler(SIMULATION_ERROR, data.details.error, '\n', simulationURL);
                            } else 
                            {
                                // redirect to a new page with the simulation URL
                                try{
                                window.open(simulationURL, '_blank');
                                } catch(e){
                                    // possibly popup blocked, instead prompt the user to copy the link
                                    alert(`Please copy the link below and paste it in your browser: ${simulationURL}`);
                                }
                            }
                        } else {
                            if(data.details.error == SIMULATION_ERROR)
                            {
                                errorHandler(SIMULATION_ERROR, data.details.msg);
                            }
                        }
                    });
                } else {
                    errorHandler(SIMULATION_ERROR, "Please enter an amount to sell");
                }
            }
        })

        // only allow numbers and decimals in the sell-amount input box
        $('#sell-amount').keypress(function (e) {
            var charCode = (e.which) ? e.which : e.keyCode;
            // check if there's already a decimal
            if ($('#sell-amount').text().indexOf('.') !== -1 && charCode == 46) {
                return false;
            }
            if (charCode != 46 && charCode > 31 && (charCode < 48 || charCode > 57))
                return false;
            return true;
        });

        // this is the javascript code to handle the "widget-disconnect" button and replace the swap button with a "connect wallet" button once a wallet is disconnected
        $('.widget-disconnect').click(function(){
            // replace the "swap" button with a "connect wallet" button
            $('.widget-connect').html('<button type="button" class="btn btn-primary" id="connectButton">Connect Wallet</button>');
            // hide the "disconnect wallet" button
            $('.widget-disconnect').css('visibility', 'hidden');
            // clear the wallet address
            $('#address').html("");
        })

        // the "+" button will allow new tokens to be added to the list of tokens to swap, it will also refresh the token list stored in local storage
        $('#widget-add').click( async function(){
            // alert asking for a token address
            var tokenAddress = prompt("Please enter the token address", "0x");
            // if the token address is valid, add it to the list of tokens to swap
            if (tokenAddress != null) {
                // remove leading and trailing whitespace
                tokenAddress = tokenAddress.trim();
                // check if the token address is valid
                if (tokenAddress.length == 42) {
                    // download the token list from the API
                    let url = `https://tokens.1inch.io/v1.1/${chainID}`;
                    await fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        // store the token list in local storage replacing the old token list
                        localStorage.setItem(`tokenList-${chainID}`, JSON.stringify(data));
                        // now fetch the token's symbol using the RPC
                        switch(chainID)
                        {
                            case 1:
                                // mainnet
                                let providerETH = new ethers.providers.JsonRpcProvider(ETH_RPC);
                                getNewToken(providerETH, tokenAddress);
                                break;
                            case 10:
                                // optimism
                                let providerOVM = new ethers.providers.JsonRpcProvider(OVM_RPC);
                                getNewToken(providerOVM, tokenAddress);
                                break;
                            case 56:
                                // bsc
                                let providerBSC = new ethers.providers.JsonRpcProvider(BSC_RPC);
                                getNewToken(providerBSC, tokenAddress);
                                break;
                            case 100:
                                // xdai
                                let providerXDai = new ethers.providers.JsonRpcProvider(XDAI_RPC);
                                getNewToken(providerXDai, tokenAddress);
                                break;
                            case 137:
                                // polygon
                                let providerPolygon = new ethers.providers.JsonRpcProvider(POLYGON_RPC);
                                getNewToken(providerPolygon, tokenAddress);
                                break;
                            case 250:
                                // fantom
                                let providerFantom = new ethers.providers.JsonRpcProvider(FANTOM_RPC);
                                getNewToken(providerFantom, tokenAddress);
                                break;
                            case 42161:
                                // arbitrum
                                let providerArbitrum = new ethers.providers.JsonRpcProvider(ARBITRUM_RPC);
                                getNewToken(providerArbitrum, tokenAddress);
                                break;
                            case 43114:
                                // avalanche
                                let providerAvalanche = new ethers.providers.JsonRpcProvider(AVALANCHE_RPC);
                                getNewToken(providerAvalanche, tokenAddress);
                                break;
                            default:
                                // error has occured
                                errorHandler(CHAIN_ERROR);
                        }
                        
                    })
                }
            }
            let tokenList = JSON.parse(localStorage.getItem(`tokenList-${chainID}`));
            populateTokenDropdown(tokenList); // will automatically add the custom tokens to the generic token list
        });

        function hex2asciiSpecial(hex)
        {
            var str = '';
            // removing leading 0x
            hex = hex.substring(2);
            for (var n = 0; n < hex.length; n += 2) {
                if(hex.substr(n, 2) != "00")
                {
                    if(parseInt(hex.substr(n, 2), 16) > 31)
                    {
                        str += String.fromCharCode(parseInt(hex.substr(n, 2), 16));
                    }
                }
            }
            //trim trailing null bytes
            return str.substring(1);
        }

        async function getNewToken(provider, tokenAddress)
        {
            let customTokens = JSON.parse(localStorage.getItem(`customTokens-${chainID}`));
            if(customTokens == null)
            {
                customTokens = {};
            }
            customTokens[tokenAddress] = {};
            try{
                let tx_symbol = 
                {
                    to: tokenAddress,
                    data: "0x95d89b41"
                }
                await provider.call(tx_symbol).then((result) => {
                    // let symbol = ethers.utils.parseBytes32String(result); // why does this not work?
                    let symbol = hex2asciiSpecial(result);
                    // add the token to the list of tokens to swap
                    customTokens[tokenAddress].symbol = symbol;
                });
                let tx_decimals = 
                {
                    to: tokenAddress,
                    data: "0x313ce567"
                }
                await provider.call(tx_decimals).then((result) => {
                    let decimals = parseInt(result); // fine because decimals is never of 18
                    // add the token to the list of tokens to swap
                    customTokens[tokenAddress].decimals = decimals;
                });
                
            } catch (e) {
                errorHandler(TOKEN_ERROR);
                // alert("Error has occured, please try again");
            }

            localStorage.setItem(`customTokens-${chainID}`, JSON.stringify(customTokens));
        }

        // the flip button will swap the selected text and value property in the "from" and "to" dropdowns
        $('#widget-flip').click(function(){
            let sellText = document.getElementById('token-button-sell').innerText;
            let sellValue = document.getElementById('token-button-sell').value;
            let buyText = document.getElementById('token-button-buy').innerText;
            let buyValue = document.getElementById('token-button-buy').value;
            document.getElementById('you-sell').href = 'https://blockscan.com/address/' + buyValue;
            document.getElementById('you-buy').href = 'https://blockscan.com/address/' + sellValue;
            document.getElementById('token-button-sell').innerText = buyText;
            document.getElementById('token-button-sell').value = buyValue;
            document.getElementById('token-button-buy').innerText = sellText;
            document.getElementById('token-button-buy').value = sellValue;
        });

        // // when the document loads set the chainID to 1
        $(document).ready(function(){
            chainID = 1;
            // set the default token to ETH
            document.getElementById('token-button-sell').innerText = "ETH";
            document.getElementById('token-button-sell').value = "0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee";
            document.getElementById('token-button-buy').innerText = "1inch";
            document.getElementById('token-button-buy').value = "0x111111111117dc0aa78b770fa6a738034120c302";
            // also add the blockscan link
            document.getElementById('you-sell').href = 'https://blockscan.com/address/0xeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee';
            document.getElementById('you-buy').href = 'https://blockscan.com/address/0x111111111117dc0aa78b770fa6a738034120c302';
            
            //check if we have a token list in local storage
            let tokenList = getTokenList();
            populateTokenDropdown(tokenList); // also a call in getTokenList() but only if the localStorage doesn't have it

            try{
            // set the default slippage to 1 in local storage
            localStorage.setItem('slippage', 1);
            } catch (e) {
                // errorHandler(LOCAL_STORAGE_ERROR);
            }
        });


        function errorHandler(error, message)
        {

            if(error === 4001)
            {
                // edit the .widget-error
                document.getElementById('widget-error').innerText = "Error: Token failed to import, please check the address and try again";
                // change text to a red color
                document.getElementById('widget-error').style.color = "red";
            } else if(error === 4002)
            {
                // edit the .widget-error
                document.getElementById('widget-error').innerText = "Error: No account detected, please connect your wallet";
                // change text to a red color
                document.getElementById('widget-error').style.color = "red";
            } else if(error === 4003)
            {
                // edit the .widget-error
                document.getElementById('widget-error').innerText = "Error: Chain not supported, please switch to a supported chain";
                // change text to a red color
                document.getElementById('widget-error').style.color = "orange";
            } else if(error === 4004)
            {
                // edit the .widget-error
                document.getElementById('widget-error').innerText = "Error: RPC error, please try again";
                // change text to a red color
                document.getElementById('widget-error').style.color = "red";
            } else if(error === 4005)
            {
                // edit the .widget-error
                document.getElementById('widget-error').innerText = "Error: Token failed to import, please check the address and try again";
                // change text to a red color
                document.getElementById('widget-error').style.color = "red";
            } else if(error === 4006)
            {
                // edit the .widget-error
                document.getElementById('widget-error').innerText = "Error: " + message;
                // change text to a red color
                document.getElementById('widget-error').style.color = "red";
            } else if (error === 4007)
            {
                // edit the .widget-error
                document.getElementById('widget-error').innerText = "Error: Amount exceeds balance"; 
                // change text to a red color
                document.getElementById('widget-error').style.color = "orange";
            } else if (error === 4008)
            {
                // edit the .widget-error
                document.getElementById('widget-error').innerText = "Error: Error rendering page, please refresh";
                // change text to a red color
                document.getElementById('widget-error').style.color = "red";
            } else if (error === 4009)

            // clear it after 10 seconds
            setTimeout(function(){
                document.getElementById('widget-error').innerText = "";
            }, 10000);
        }

    </script>
</html>