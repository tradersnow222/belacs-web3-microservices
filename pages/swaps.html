<!DOCTYPE html>
<html>
    <head>
        <title>Swaps</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

        <script>

        </script>

    </head>

    <body>  
        <!-- headder bar to redirect to home -->
        <nav class="navbar-inverse">
            <div>
                <div class="container-fluid">
                    <div class="navbar-header">
                        <a class="navbar-brand" href="/">Home</a>
                    </div>
                </div>
            </div>
            <div class="network-select">
                <div class="dropdown">
                    <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Select Network
                    <span class="caret"></span></button>
                    <ul class="dropdown-menu">
                        <li><a href="#" onclick="chainID=1">Ethereum</a></li>
                        <li><a href="#" onclick="chainID=10">Optimism</a></li>
                        <li><a href="#" onclick="chainID=56">BNB Chain</a></li>
                        <li><a href="#" onclick="chainID=100">Gnosis</a></li>
                        <li><a href="#" onclick="chainID=137">Polygon</a></li>
                        <li><a href="#" onclick="chainID=250">Fantom</a></li>
                        <li><a href="#" onclick="chainID=42161">Arbitrum</a></li>
                        <li><a href="#" onclick="chainID=43114">Avalanche</a></li>
                        <!-- klaytn and aurora aren't supported by tenderly so we'll leave them in comments -->
                        <!-- <li><a href="#" onclick="chainID=8217">Klaytn</a></li> -->
                        <!-- <li><a href="#" onclick="chainID=1313161554">Aurora</a></li> -->                    
                    </ul>
                </div>
            </div>
        </nav>
        <!-- this will be a centered form to hold the swap widget -->
        <div class="container-widget">
            <div class="widget">
                <!-- widget header with a left aligned SWAP text and 3 right aligned buttons, refresh, + and settings  all on the same row-->
                <div class="widget-header">
                    <div class="col-sm-3">
                        <h3>SWAP</h3>
                    </div>
                    <div class="col-sm-9">
                        <button type="button" class="btn btn-default btn-sm" id="refreshButton">
                            <span class="glyphicon glyphicon-refresh"></span> <!-- Refresh-->
                        </button>
                        <button type="button" class="btn btn-default btn-sm" id="addButton">
                            <span class="glyphicon glyphicon-plus"></span> <!-- Add -->
                        </button>
                        <button type="button" class="btn btn-default btn-sm" id="settingsButton">
                            <span class="glyphicon glyphicon-cog"></span> <!-- Settings -->
                        </button>
                    </div>
                </div>
                <!-- the "you sell" field of the widget. A master div has 3 left aligned elements and 3 right aligned elements -->
                <div class="widget-sell">
                    <!-- first row, the left align is the "you sell" hyperlink the rigth align is "Balance" -->
                    <div class="row">
                        <div class="col-sm-3">
                            <a target="_blank" id="you-sell" href="#">You Sell</a>
                        </div>
                        <div class="col-sm-9">
                            <a href="#">Balance</a>
                        </div>
                    </div>
                    <!-- The second row, the left is a drop down for token selection (filled by javascript) and the rigth is an editable div for input amounts -->
                    <div class="row">
                        <div class="col-sm-3">
                            <div class="dropdown">
                                <button id="token-button-sell" class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Select Token
                                <span class="caret"></span></button>
                                <ul class="dropdown-menu" id="token-list-selector-sell">
                                    <!-- javascript will fill this -->
                                </ul>
                            </div>
                        </div>
                        <!-- this input will just be a transparent editable div that's right aligned -->
                        <div class="col-sm-9">
                            <div class="input-group">
                                <div contenteditable="true" class="" id="sellAmount">0</div>
                            </div>
                        </div>
                    </div>
                    <!-- the third row will be token full name and price, but we won't have this for now-->
                </div>

                <!-- button with arrows side by side pointing up and down to allow the user to flip the buy and sell token -->
                <div class="widget-button">
                    <button type="button" class="btn btn-default btn-sm" id="flipButton">
                        <span class="glyphicon glyphicon-arrow-up"></span>
                        <span class="glyphicon glyphicon-arrow-down"></span>
                    </button>
                </div>

                <!-- same thing as widget sell but instead it's you buy -->
                <div class="widget-buy">
                    <div class="row">
                        <div class="col-sm-3">
                            <a target="_blank" id="you-buy" href="#">You Buy</a>
                        </div>
                        <div class="col-sm-9">
                            <a href="#">Balance</a>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-3">
                            <div class="dropdown">
                                <button id="token-button-buy" class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Select Token
                                <span class="caret"></span></button>
                                <ul class="dropdown-menu" id="token-list-selector-buy">
                                    <!-- javascript will fill this -->
                                </ul>
                            </div>
                        </div>
                        <div class="col-sm-9">
                            <div class="input-group">
                                <div contenteditable="true" class="" id="buyAmount">0</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- lastly we'll have a "connect wallet" button that will bring up a popup asking for a wallet. Once there's a valid wallet, it will change to the "swap" button -->
                <div class="widget-connect">
                    <button type="button" class="btn btn-primary" id="connectButton">Connect Public Address</button>
                </div>
                <!-- disconnect wallet button, not visible by default -->
                <div class="widget-disconnect">
                    <button type="button" class="btn btn-primary" id="disconnectButton">Disconnect Wallet</button>
                </div>
                <!-- finally, a place to display the connected address in small 6pt font -->
                <div class="widget-address">
                    <p id="address"></p>
                </div>  
            </div>
        </div>
    </body>

    <style>
        .navbar-inverse {
            display: flex;
            flex-direction: row;
        }
        /* add padding to the network-select to fit within */
        .network-select {
            padding: 7px;
        }
        .container-widget{
            display: flex;
            justify-content: center;
        }
        .widget{
            width:100%;
            max-width: 500px;
            border: 1px solid black;
            border-radius: 5px;
            padding: 10px;
            margin: 20px;
            height:400px; /* maybe can be tinier? */
        }
        .widget-header{
            display: flex;
            flex-direction: row;
            /* make sure everything is lined up */
            align-items: center;
        }
        /* right align the settings */
        .widget-header > div:nth-child(2){
            display: flex;
            justify-content: flex-end;
            /* space the inside elements */
            gap: 10px;
        }
        .widget-sell{
            /* give it a grey background */
            background-color: #e6e6e6;
            /* give it a border */
            border: 1px solid black;
            border-radius: 5px;
            padding: 10px;
            margin: 10px;
            height: fit-content;
        }
        /* the first row in widget-sell, left align the first element and right align the second */
        .widget-sell > div:nth-child(1){
            display: flex;
            flex-direction: row;
            align-items: center;
        }
        .widget-sell > div:nth-child(1) > div:nth-child(2){
            display: flex;
            justify-content: flex-end;
        }
        /* the second row in widget-sell, left align the first element and right align the second */
        .widget-sell > div:nth-child(2){
            display: flex;
            flex-direction: row;
            align-items: center;
        }
        .widget-sell > div:nth-child(2) > div:nth-child(2){
            display: flex;
            justify-content: flex-end;
        }
        .input-group{
            width: 100%;
            text-align: right;
        }
        .widget-buy{
            /* give it a grey background */
            background-color: #e6e6e6;
            /* give it a border */
            border: 1px solid black;
            border-radius: 5px;
            padding: 10px;
            margin: 10px;
            height: fit-content;
        }
        /* the first row in widget-buy, left align the first element and right align the second */
        .widget-buy > div:nth-child(1){
            display: flex;
            flex-direction: row;
            align-items: center;
        }
        .widget-buy > div:nth-child(1) > div:nth-child(2){
            display: flex;
            justify-content: flex-end;
        }
        /* the second row in widget-buy, left align the first element and right align the second */
        .widget-buy > div:nth-child(2){
            display: flex;
            flex-direction: row;
            align-items: center;
        }
        .widget-buy > div:nth-child(2) > div:nth-child(2){
            display: flex;
            justify-content: flex-end;
        }

        /* center widget-button */
        .widget-button{
            display: flex;
            justify-content: center;
            align-items: center;
        }
        /* center widget-connect */
        .widget-connect{
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .widget-connect > button{
            width: 97%;
        }

        .widget-disconnect {
            /* hide the button */
            visibility: hidden;
            /* add a little padding so it doesn't run up against the connect button */
            padding: 5px;
            /* right align the content */
            display: flex;
            justify-content: flex-end;
        }

        .widget-address{
            /* add a little padding so it doesn't run up against the connect button */
            padding: 5px;
            /* center */
            display: flex;
            justify-content: center;
            align-items: center;
            /* shrink the font and color it grey */
            font-size: 6pt;
            color: grey;
        }

    </style>
    <script>

        function searchTokenListSell()
        {
            // Declare variables
            var input, filter, ul, li, a, i, txtValue;
            input = document.getElementById('token-search-sell');
            filter = input.value.toUpperCase();
            ul = document.getElementById("token-list-selector-sell");
            li = ul.getElementsByTagName('option');

            // Loop through all list items, and hide those who don't match the search query
            for (i = 0; i < li.length; i++) {
                 // Loop through all list items, and hide those who don't match the search query
                 if (filter.length == 42) {
                    // if it's an address, check if the li[i].value matches
                    txtValue = li[i].value.toUpperCase();
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        li[i].style.display = "";
                        li[i].style.visibility = "visible";
                    } else {
                        li[i].style.display = "none";
                        li[i].style.visibility = "hidden";
                    }
                } else {
                    // if it's not an address, check if the li[i].text matches
                    txtValue = li[i].text.toUpperCase();
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        li[i].style.display = "";
                        li[i].style.visibility = "visible";
                    } else {
                        li[i].style.display = "none";
                        li[i].style.visibility = "hidden";
                    }
                 }
            }
        }

        function searchTokenListBuy()
        {
            // Declare variables
            var input, filter, ul, li, a, i, txtValue;
            input = document.getElementById('token-search-buy');
            filter = input.value.toUpperCase();
            ul = document.getElementById("token-list-selector-buy");
            li = ul.getElementsByTagName('option');
            // Loop through all list items, and hide those who don't match the search query
            for (i = 0; i < li.length; i++) {
                // check if the search term is the token symbol or an address
                if(filter.length == 42){
                    // if it's an address, check if the address matches
                    txtValue = li[i].value.toUpperCase();

                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        li[i].style.display = "";
                        li[i].style.visibility = "visible";
                    } else {
                        li[i].style.display = "none";
                        li[i].style.visibility = "hidden";
                    }
                } else {
                    // if it's not an address, check if the symbol matches
                    txtValue = li[i].innerText.toUpperCase();
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        li[i].style.display = "";
                        li[i].style.visibility = "visible";
                    } else {
                        li[i].style.display = "none";
                        li[i].style.visibility = "hidden";
                    }
                }
            }
        }

        function populateTokenDropdown(tokenlist)
        {
            // expected tokenlist will look like
            // {"0x0327112423f3a68efdf1fcf402f6c5cb9f7c33fd":{"symbol":"BTC++","name":"PieDAO BTC++","decimals":18,"address":"0x0327112423f3a68efdf1fcf402f6c5cb9f7c33fd","logoURI":"https://tokens.1inch.io/0x0327112423f3a68efdf1fcf402f6c5cb9f7c33fd.png","tags":["tokens","PEG:BTC"]},"0x04fa0d235c4abf4bcf4787af4cf447de572ef828":{"symbol":"UMA","name":"UMA Voting Token v1","decimals":18,"address":"0x04fa0d235c4abf4bcf4787af4cf447de572ef828","logoURI":"https://tokens.1inch.io/0x04fa0d235c4abf4bcf4787af4cf447de572ef828.png","tags":["tokens"]}}
            // we want to populate the dropdown with the symbol and address along with a search bar at the top of the token list
            let dropdownBuy = document.getElementById("token-list-selector-buy");
            let dropdownSell = document.getElementById("token-list-selector-sell");
            // clear the dropdown
            dropdownBuy.innerHTML = "";
            dropdownSell.innerHTML = "";

            // add a search bar
            let searchbar_sell = document.createElement("input");
            searchbar_sell.setAttribute("type", "text");
            searchbar_sell.setAttribute("id", "token-search-sell");
            searchbar_sell.setAttribute("onkeyup", "searchTokenListSell()");
            searchbar_sell.setAttribute("placeholder", "Search for tokens...");
            dropdownSell.appendChild(searchbar_sell);
            let searchbar_buy = document.createElement("input");
            searchbar_buy.setAttribute("type", "text");
            searchbar_buy.setAttribute("id", "token-search-buy");
            searchbar_buy.setAttribute("onkeyup", "searchTokenListBuy()");
            searchbar_buy.setAttribute("placeholder", "Search for tokens...");
            dropdownBuy.appendChild(searchbar_buy);

            // add a divider
            let divider_sell = document.createElement("hr");
            dropdownSell.appendChild(divider_sell);
            let divider_buy = document.createElement("hr");
            dropdownBuy.appendChild(divider_buy);


            // add the tokens for the sell dropdown
            for (const [key, value] of Object.entries(tokenlist)) {
                // create a new option element
                let option = document.createElement("option");
                // set the value to the address
                option.setAttribute("value", key);
                // set the text to the symbol
                option.text = value.symbol;
                // when the option is clicked, set the text of the button to the symbol, also edit the "you sell" hyperlink to https://blockscan.com/address/ + address
                option.setAttribute("onclick", "document.getElementById('token-button-sell').innerHTML = this.text; document.getElementById('you-sell').href = 'https://blockscan.com/address/' + this.value;");
                // add the option to the dropdown
                dropdownSell.appendChild(option);
            }
            // add the tokens for the buy dropdown
            for (const [key, value] of Object.entries(tokenlist)) {
                // create a new option element
                let option = document.createElement("option");
                // set the value to the address
                option.setAttribute("value", key);
                // set the text to the symbol
                option.text = value.symbol;
                // when the option is clicked, set the text of the button to the symbol
                option.setAttribute("onclick", "document.getElementById('token-button-buy').innerHTML = this.text; document.getElementById('you-buy').href = 'https://blockscan.com/address/' + this.value;");
                // add the option to the dropdown
                dropdownBuy.appendChild(option);
            }

        }


        // listen for the chain dropdown button to be clicked and change the text to the selected network
        $('.dropdown-menu li a').click(function(){
            var selText = $(this).text();
            $(this).parents('.dropdown').find('.dropdown-toggle').html(selText+' <span class="caret"></span>');
            // if we wanted to we could change the style of the button to match the network selected
            // TODO: change the style of the button to match the network selected

            // this will handle the token dropdown, we'll pull the token lists from https://tokens.1inch.io/v1.1/${chainID}
            // and populate the dropdown with the token names and symbols along with a "search" function. we'll call the API when the network is changed if local storage is empty
            let url = `https://tokens.1inch.io/v1.1/${chainID}`;
            // first check if we have the token list in local storage
            let tokenList = localStorage.getItem(`tokenList-${chainID}`);
            if(tokenList){
                // we have the token list in local storage, parse it and populate the dropdown
                tokenList = JSON.parse(tokenList);
                populateTokenDropdown(tokenList);
            } else {
                // we don't have the token list in local storage, fetch it from the API
                fetch(url)
                .then(response => response.json())
                .then(data => {
                    // store the token list in local storage
                    localStorage.setItem(`tokenList-${chainID}`, JSON.stringify(data));
                    // populate the dropdown
                    populateTokenDropdown(data);
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
            }
        });

        // this is the javascript code to handle the "widget-connect" button and replace it with a "swap" button once a wallet is connected
        $('.widget-connect').click(function(){
            // alert askign for a wallet address
            var walletAddress = prompt("Please enter your wallet address", "0x");
            // if the wallet address is valid, replace the "connect wallet" button with a "swap" button
            if (walletAddress != null) {
                // remove leading and trailing whitespace
                walletAddress = walletAddress.trim();
                // check if the wallet address is valid
                if (walletAddress.startsWith("0x") && walletAddress.length == 42) {
                    // replace the "connect wallet" button with a "swap" button
                    $('.widget-connect').html('<button type="button" class="btn btn-primary" id="swapButton">Swap</button>');
                    // show the "disconnect wallet" button
                    $('.widget-disconnect').css('visibility', 'visible');
                    // display the wallet address
                    $('#address').html(walletAddress);
                }
            }
        })

        // this is the javascript code to handle the "widget-disconnect" button and replace the swap button with a "connect wallet" button once a wallet is disconnected
        $('.widget-disconnect').click(function(){
            // replace the "swap" button with a "connect wallet" button
            $('.widget-connect').html('<button type="button" class="btn btn-primary" id="connectButton">Connect Wallet</button>');
            // hide the "disconnect wallet" button
            $('.widget-disconnect').css('visibility', 'hidden');
            // clear the wallet address
            $('#address').html("");
        })



    </script>
</html>